<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sri Siri Foods</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --saffron:#E8820C;--sl:#FFF3E0;--sd:#BF6A08;
  --green:#2E7D32;--gl:#E8F5E9;
  --red:#C62828;--rl:#FFEBEE;
  --blue:#1565C0;--bl:#E3F2FD;
  --bg:#FAFAF7;--card:#fff;--text:#1A1A1A;--muted:#6B6B6B;
  --border:#E8E2D9;--shadow:0 2px 12px rgba(0,0,0,.08);--radius:12px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#loginScreen{min-height:100vh;background:linear-gradient(135deg,#1A1A1A,#2C1A06 60%,#E8820C);display:flex;align-items:center;justify-content:center;flex-direction:column;}
.login-card{background:#fff;border-radius:20px;padding:40px 44px 36px;width:380px;box-shadow:0 24px 60px rgba(0,0,0,.3);}
.shop-logo{text-align:center;margin-bottom:28px;}
.shop-logo .icon{font-size:48px;margin-bottom:6px;}
.shop-logo h1{font-family:'Playfair Display',serif;font-size:26px;color:var(--saffron);}
.shop-logo p{font-size:12px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:4px;}
.role-tabs{display:flex;gap:8px;margin-bottom:24px;}
.role-tab{flex:1;padding:10px;border:2px solid var(--border);border-radius:8px;background:transparent;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;color:var(--muted);transition:all .2s;}
.role-tab.active{border-color:var(--saffron);background:var(--sl);color:var(--saffron);}
.lfield{margin-bottom:18px;}
.lfield label{display:block;font-size:13px;font-weight:500;color:var(--muted);margin-bottom:6px;}
.lfield input{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:15px;outline:none;transition:border-color .2s;}
.lfield input:focus{border-color:var(--saffron);}
.btn-login{width:100%;padding:13px;background:var(--saffron);color:#fff;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:background .2s;margin-top:4px;}
.btn-login:hover{background:var(--sd);}
.lerr{color:var(--red);font-size:13px;text-align:center;margin-top:10px;min-height:18px;}

/* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
#appScreen{display:none;flex-direction:column;min-height:100vh;}
header{background:#1A1A1A;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.3);}
header h1{font-family:'Playfair Display',serif;color:var(--saffron);font-size:20px;}
.hright{display:flex;align-items:center;gap:12px;}
.rbadge{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;}
.rbadge.admin{background:var(--saffron);color:#fff;}
.rbadge.staff{background:#fff2;color:#fff;border:1px solid #fff3;}
.btn-logout{padding:6px 14px;background:transparent;color:#aaa;border:1px solid #444;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;transition:all .2s;}
.btn-logout:hover{border-color:#fff;color:#fff;}
.nav-tabs{background:var(--card);border-bottom:2px solid var(--border);display:flex;padding:0 24px;overflow-x:auto;flex-shrink:0;}
.nav-tab{padding:14px 20px;border:none;background:transparent;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;color:var(--muted);border-bottom:3px solid transparent;margin-bottom:-2px;white-space:nowrap;transition:all .2s;}
.nav-tab.active{color:var(--saffron);border-bottom-color:var(--saffron);}
main{flex:1;padding:24px;max-width:1400px;margin:0 auto;width:100%;}
.page{display:none;}.page.active{display:block;}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card{background:var(--card);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:20px;}
.card-title{font-family:'Playfair Display',serif;font-size:18px;margin-bottom:14px;}
.section-heading{font-family:'Playfair Display',serif;font-size:22px;margin-bottom:6px;}
.section-sub{font-size:13px;color:var(--muted);margin-bottom:20px;}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.frow{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;margin-bottom:14px;}
.fg{display:flex;flex-direction:column;gap:5px;min-width:160px;}
.fg label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;}
.fg select,.fg input{padding:10px 12px;border:2px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;background:#fff;transition:border-color .2s;}
.fg select:focus,.fg input:focus{border-color:var(--saffron);}
.fg select:disabled,.fg input:disabled{background:#f5f5f5;color:#aaa;cursor:not-allowed;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn-p{padding:10px 24px;background:var(--saffron);color:#fff;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:background .2s;white-space:nowrap;}
.btn-p:hover{background:var(--sd);}
.btn-p:disabled{background:#ccc;cursor:not-allowed;}
.btn-s{padding:10px 20px;background:transparent;color:var(--saffron);border:2px solid var(--saffron);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;}
.btn-s:hover{background:var(--sl);}
.btn-d{padding:5px 12px;background:transparent;color:var(--red);border:1px solid var(--red);border-radius:6px;font-size:12px;cursor:pointer;}
.btn-d:hover{background:var(--rl);}
.btn-cancel{padding:10px 20px;background:transparent;color:var(--muted);border:2px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;cursor:pointer;}

/* ‚îÄ‚îÄ TXN PANEL ‚îÄ‚îÄ */
.txn-panel{background:linear-gradient(135deg,#FFF8F0,#FFFDF9);border:2px solid #F5C87A;border-radius:var(--radius);padding:22px;margin-bottom:20px;}
.txn-title{font-size:15px;font-weight:700;color:var(--sd);margin-bottom:16px;}
.txn-type-row{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center;}
.ttype-btn{padding:8px 18px;border:2px solid var(--border);border-radius:20px;background:#fff;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;color:var(--muted);transition:all .2s;}
.ttype-btn.t-closing{border-color:var(--saffron);background:var(--sl);color:var(--sd);}
.ttype-btn.t-purchase{border-color:var(--blue);background:var(--bl);color:var(--blue);}
.ttype-btn.t-opening{border-color:var(--green);background:var(--gl);color:var(--green);}

/* ‚îÄ‚îÄ INFO BOX ‚îÄ‚îÄ */
.info-box{background:#fff;border:1px solid var(--border);border-radius:10px;padding:16px;margin:14px 0;display:none;}
.info-box.on{display:block;}
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:12px;}
.info-item{text-align:center;}
.info-lbl{font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);margin-bottom:4px;}
.info-val{font-weight:700;font-size:20px;}
.info-val.g{color:var(--green);}
.info-val.o{color:var(--saffron);}
.info-val.b{color:var(--blue);}

/* ‚îÄ‚îÄ LOCKED ‚îÄ‚îÄ */
.locked-banner{background:#fff3cd;border:1px solid #ffc107;border-radius:var(--radius);padding:14px 20px;margin-bottom:20px;display:none;align-items:center;gap:10px;font-size:14px;color:#856404;font-weight:500;}
.locked-banner.on{display:flex;}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.twrap{overflow-x:auto;max-height:600px;overflow-y:auto;}
table{width:100%;border-collapse:collapse;font-size:14px;}
thead th{background:#F5F0EB;padding:10px 12px;text-align:left;font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);white-space:nowrap;border-bottom:2px solid var(--border);position:sticky;top:0;z-index:2;}
tbody tr{border-bottom:1px solid #F0EBE5;transition:background .1s;}
tbody tr:hover{background:#FDFAF6;}
tbody td{padding:10px 12px;vertical-align:middle;}
.pname{font-weight:500;}
.pid{font-size:11px;color:var(--muted);}
.cbadge{display:inline-block;padding:2px 9px;border-radius:10px;font-size:11px;font-weight:600;background:#f0ebe5;color:#666;}
.sum-row{background:#FFF8F0!important;}
.sum-row td{border-top:2px solid var(--saffron)!important;font-weight:700;}
.tag-c{display:inline-block;padding:2px 9px;border-radius:10px;font-size:11px;font-weight:600;background:var(--sl);color:var(--sd);}
.tag-p{display:inline-block;padding:2px 9px;border-radius:10px;font-size:11px;font-weight:600;background:var(--bl);color:var(--blue);}
.tag-o{display:inline-block;padding:2px 9px;border-radius:10px;font-size:11px;font-weight:600;background:var(--gl);color:var(--green);}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:16px;margin-bottom:24px;}
.stat-card{background:var(--card);border-radius:var(--radius);padding:20px;border:1px solid var(--border);box-shadow:var(--shadow);text-align:center;}
.slbl{font-size:11px;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);margin-bottom:8px;}
.sval{font-family:'Playfair Display',serif;font-size:28px;font-weight:700;}

/* ‚îÄ‚îÄ FILTER PANEL ‚îÄ‚îÄ */
.filter-panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px 24px;margin-bottom:20px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:14px;}
.fb{display:flex;flex-direction:column;gap:8px;}
.fblbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);}
.pill-grp{display:flex;flex-wrap:wrap;gap:7px;}
.pill{padding:6px 14px;border:2px solid var(--border);border-radius:20px;background:#fff;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;color:var(--muted);transition:all .15s;white-space:nowrap;}
.pill:hover{border-color:#ccc;color:var(--text);}
.pill.on{border-color:var(--saffron);background:var(--sl);color:var(--sd);font-weight:600;}
.cpill.on{border-color:#aaa;background:#f5f5f5;color:var(--text);}
.cpill:not(.on){border-color:#eee;background:#fafafa;color:#bbb;text-decoration:line-through;}
.fsearch{padding:9px 14px;border:2px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;width:100%;max-width:360px;transition:border-color .2s;}
.fsearch:focus{border-color:var(--saffron);}
.btn-ghost{padding:6px 14px;background:transparent;border:1px solid var(--border);border-radius:20px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .2s;}
.btn-ghost:hover{border-color:var(--saffron);color:var(--saffron);}

/* ‚îÄ‚îÄ DATE RANGE ‚îÄ‚îÄ */
.date-range-bar{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;margin-bottom:20px;box-shadow:var(--shadow);}
.date-range-bar .fg{min-width:150px;}
.quick-ranges{display:flex;gap:6px;flex-wrap:wrap;margin-top:2px;}
.qbtn{padding:5px 12px;border:1.5px solid var(--border);border-radius:20px;background:#fff;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;color:var(--muted);transition:all .15s;}
.qbtn:hover,.qbtn.on{border-color:var(--saffron);background:var(--sl);color:var(--sd);}

/* ‚îÄ‚îÄ CATEGORY CHIPS ‚îÄ‚îÄ */
.cat-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;background:var(--sl);border:2px solid #F5C87A;font-size:13px;font-weight:600;color:var(--sd);}
.cat-chip.def{background:#f5f5f5;border-color:#ddd;color:#999;}
.del-cat{background:none;border:none;cursor:pointer;color:inherit;font-size:14px;line-height:1;padding:0;opacity:.55;transition:opacity .2s;}
.del-cat:hover{opacity:1;}

/* ‚îÄ‚îÄ UNLOCK ‚îÄ‚îÄ */
.unlock-sec{background:var(--sl);border:1px solid #F5C87A;border-radius:var(--radius);padding:20px;margin-bottom:20px;}
.unlock-sec h3{color:var(--sd);margin-bottom:10px;font-size:15px;font-weight:700;}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;}
.modal-ov.on{display:flex;}
.modal{background:#fff;border-radius:16px;padding:32px;width:480px;max-width:95vw;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.modal h2{font-family:'Playfair Display',serif;font-size:20px;margin-bottom:20px;}
.mrow{margin-bottom:14px;}
.mrow label{display:block;font-size:11px;font-weight:700;color:var(--muted);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px;}
.mrow input,.mrow select{width:100%;padding:10px 12px;border:2px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;}
.mrow input:focus,.mrow select:focus{border-color:var(--saffron);}
.mactions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:#222;color:#fff;padding:12px 24px;border-radius:40px;font-size:14px;font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.3);transition:transform .3s;z-index:999;white-space:nowrap;}
#toast.on{transform:translateX(-50%) translateY(0);}
#toast.ok{background:var(--green);}
#toast.err{background:var(--red);}

/* ‚îÄ‚îÄ NO DATA ‚îÄ‚îÄ */
.nodata{text-align:center;padding:48px;color:var(--muted);font-size:14px;}

/* Staff stock filter pills */
.spill{padding:6px 14px;border:2px solid var(--border);border-radius:20px;background:#fff;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;color:var(--muted);transition:all .15s;white-space:nowrap;}
.spill:hover{border-color:#ccc;color:var(--text);}
.spill.on{border-color:var(--saffron);background:var(--sl);color:var(--sd);font-weight:600;}

@media(max-width:640px){
  main{padding:12px;}
  .login-card{width:95vw;padding:28px 20px;}
  header{padding:12px 16px;}
  header h1{font-size:16px;}
  .nav-tabs{padding:0 6px;}
  .nav-tab{padding:12px 8px;font-size:12px;}
  table{font-size:12px;}
  .fg{min-width:130px;}
  .filter-panel{padding:14px;}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê -->
<div id="loginScreen">
  <div class="login-card">
    <div class="shop-logo">
      <div class="icon">üè™</div>
      <h1>Sri Siri Foods</h1>
      <p>Inventory Management</p>
    </div>
    <div class="role-tabs">
      <button class="role-tab active" onclick="selectRole('admin')">üëë Admin</button>
      <button class="role-tab" onclick="selectRole('staff')">üßë‚Äçüíº Staff</button>
    </div>
    <div class="lfield">
      <label>Password</label>
      <input type="password" id="loginPw" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="btn-login" onclick="doLogin()">Login</button>
    <div class="lerr" id="loginErr"></div>
  </div>
  <p style="color:#ffffff44;font-size:12px;margin-top:20px;">Default: Admin ‚Üí <b style="color:#fff8">admin123</b> &nbsp;|&nbsp; Staff ‚Üí <b style="color:#fff8">staff123</b></p>
</div>

<!-- ‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê -->
<div id="appScreen">
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <span style="font-size:22px;">üè™</span>
      <h1>Sri Siri Foods</h1>
    </div>
    <div class="hright">
      <div class="rbadge" id="roleBadge"></div>
      <div id="clockEl" style="color:#aaa;font-size:13px;"></div>
      <button class="btn-logout" onclick="doLogout()">Logout</button>
    </div>
  </header>
  <nav class="nav-tabs" id="navTabs"></nav>
  <main>

    <!-- ‚îÄ‚îÄ STAFF: Update Inventory ‚îÄ‚îÄ -->
    <div class="page" id="page-update">
      <div class="locked-banner" id="lockBanner">üîí Updates locked after 11:59 PM. Ask Admin to unlock.</div>

      <!-- Top bar: date + filters -->
      <div class="date-range-bar" style="margin-bottom:12px;flex-wrap:wrap;gap:12px;">
        <div class="fg">
          <label>Date</label>
          <input type="date" id="txnDate" onchange="onStaffDateChange()">
        </div>
        <div class="fg">
          <label>Category</label>
          <select id="staffCatFilter" onchange="renderStaffTable()">
            <option value="">All Categories</option>
          </select>
        </div>
        <div class="fg">
          <label>Search</label>
          <input type="text" id="staffSearch" placeholder="Product name..." oninput="renderStaffTable()">
        </div>
      </div>

      <!-- Stock filters row -->
      <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px 20px;margin-bottom:16px;display:flex;flex-wrap:wrap;gap:16px;align-items:flex-end;box-shadow:var(--shadow);">
        <!-- Stock status pills -->
        <div style="display:flex;flex-direction:column;gap:7px;">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);">Stock Status</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="spill on" data-stock="all"      onclick="setStockPill(this)">All Products</button>
            <button class="spill"    data-stock="instock"  onclick="setStockPill(this)">‚úÖ In Stock</button>
            <button class="spill"    data-stock="outstock" onclick="setStockPill(this)">‚ùå Out of Stock</button>
          </div>
        </div>

        <!-- Divider -->
        <div style="width:1px;background:var(--border);align-self:stretch;margin:0 4px;"></div>

        <!-- Greater than / Less than range -->
        <div style="display:flex;flex-direction:column;gap:7px;">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--muted);">Available Stock Range</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:6px;">
              <span style="font-size:13px;color:var(--muted);font-weight:500;">Min&nbsp;‚â•</span>
              <input type="number" id="stockMin" min="0" placeholder="0"
                style="width:72px;padding:6px 8px;border:2px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;text-align:center;"
                onfocus="this.style.borderColor='var(--saffron)'" onblur="this.style.borderColor='var(--border)'"
                oninput="renderStaffTable()">
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
              <span style="font-size:13px;color:var(--muted);font-weight:500;">Max&nbsp;‚â§</span>
              <input type="number" id="stockMax" min="0" placeholder="‚àû"
                style="width:72px;padding:6px 8px;border:2px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;text-align:center;"
                onfocus="this.style.borderColor='var(--saffron)'" onblur="this.style.borderColor='var(--border)'"
                oninput="renderStaffTable()">
            </div>
            <button class="btn-ghost" onclick="clearStockRange()">‚úï Clear</button>
          </div>
        </div>

        <!-- Spacer + result count -->
        <div style="margin-left:auto;align-self:center;">
          <span id="staffProgress" style="font-size:13px;color:var(--muted);white-space:nowrap;"></span>
        </div>
      </div>

      <!-- Progress bar -->
      <div style="background:#F0EBE5;border-radius:8px;height:8px;margin-bottom:20px;overflow:hidden;">
        <div id="staffProgressBar" style="height:100%;background:linear-gradient(90deg,var(--green),#66BB6A);border-radius:8px;width:0%;transition:width .4s ease;"></div>
      </div>

      <!-- Stats -->
      <div class="stats-grid" id="staffStats" style="margin-bottom:20px;"></div>

      <!-- Product Table -->
      <div class="card" style="padding:0;overflow:hidden;margin-bottom:20px;">
        <div class="twrap" id="staffTableWrap">
          <div class="nodata" style="padding:48px;">Select a date to begin entering closing stock.</div>
        </div>
      </div>

      <!-- Submit Button -->
      <div id="staffSubmitBar" style="display:none;position:sticky;bottom:0;background:rgba(250,250,247,.95);backdrop-filter:blur(8px);border-top:2px solid var(--border);padding:16px 0;margin:0 -24px;padding-left:24px;padding-right:24px;z-index:50;">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;max-width:1400px;margin:0 auto;">
          <div>
            <div style="font-weight:700;font-size:15px;" id="submitSummary">0 products updated</div>
            <div style="font-size:12px;color:var(--muted);" id="submitDate"></div>
          </div>
          <div style="display:flex;gap:10px;">
            <button class="btn-s" onclick="renderStaffTable()">‚Ü∫ Refresh</button>
            <button class="btn-p" id="submitBtn" onclick="submitAllData()"
              style="background:var(--green);font-size:15px;padding:12px 32px;"
              onmouseover="this.style.background='#1B5E20'" onmouseout="this.style.background='var(--green)'">
              ‚úÖ Submit Day's Data
            </button>
          </div>
        </div>
      </div>

      <!-- Submission History -->
      <div class="card" id="submissionCard" style="display:none;">
        <h3 class="card-title">üìã Today's Submission Log</h3>
        <div id="submissionLog"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ADMIN: Sales Report ‚îÄ‚îÄ -->
    <div class="page" id="page-sales">
      <h2 class="section-heading">Daily Sales Report</h2>
      <p class="section-sub">Sales = Opening + Purchases ‚àí Closing &nbsp;|&nbsp; Filter by date or range below.</p>

      <!-- Date Range Bar -->
      <div class="date-range-bar">
        <div class="fg"><label>From Date</label><input type="date" id="salesFrom" onchange="onSalesDateChange()"></div>
        <div class="fg"><label>To Date</label><input type="date" id="salesTo" onchange="onSalesDateChange()"></div>
        <div class="fg"><label>&nbsp;</label><button class="btn-p" onclick="loadSalesReport()">Apply</button></div>
        <div class="fg"><label>&nbsp;</label><button class="btn-s" onclick="exportCSV()">‚¨á Export CSV</button></div>
        <div class="fg"><label>&nbsp;</label><button class="btn-p" style="background:#188038;" onmouseover="this.style.background='#146c30'" onmouseout="this.style.background='#188038'" onclick="syncToSheets()" id="syncBtn">‚òÅÔ∏è Sync to Sheets</button></div>
        <div style="display:flex;flex-direction:column;gap:5px;">
          <label style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;">Quick Range</label>
          <div class="quick-ranges">
            <button class="qbtn on" onclick="setQuick('today',this)">Today</button>
            <button class="qbtn" onclick="setQuick('yesterday',this)">Yesterday</button>
            <button class="qbtn" onclick="setQuick('week',this)">This Week</button>
            <button class="qbtn" onclick="setQuick('month',this)">This Month</button>
            <button class="qbtn" onclick="setQuick('custom',this)">Custom</button>
          </div>
        </div>
      </div>

      <div class="stats-grid" id="salesStats"></div>

      <!-- Filter Panel -->
      <div class="filter-panel">
        <div class="fb">
          <div class="fblbl">üîç Search</div>
          <input class="fsearch" type="text" id="salesSearch" placeholder="Product name or ID..." oninput="filterSales()">
        </div>
        <div class="fb">
          <div class="fblbl">üóÇ Category</div>
          <div class="pill-grp" id="catPills"></div>
        </div>
        <div class="fb">
          <div class="fblbl">üìä Sales Status</div>
          <div class="pill-grp">
            <button class="pill on" data-grp="status" data-val="all" onclick="setPill(this,'status')">All Products</button>
            <button class="pill" data-grp="status" data-val="sold" onclick="setPill(this,'status')">With Sales Only</button>
            <button class="pill" data-grp="status" data-val="notsold" onclick="setPill(this,'status')">Zero / No Data</button>
          </div>
        </div>
        <div class="fb">
          <div class="fblbl">üëÅ Show / Hide Columns</div>
          <div class="pill-grp" id="colPills">
            <button class="pill cpill on" data-col="cat"       onclick="toggleCol(this)">Category</button>
            <button class="pill cpill on" data-col="cost"      onclick="toggleCol(this)">Cost</button>
            <button class="pill cpill on" data-col="price"     onclick="toggleCol(this)">Price</button>
            <button class="pill cpill on" data-col="opening"   onclick="toggleCol(this)">Opening</button>
            <button class="pill cpill on" data-col="purchases" onclick="toggleCol(this)">Purchases</button>
            <button class="pill cpill on" data-col="closing"   onclick="toggleCol(this)">Closing</button>
            <button class="pill cpill on" data-col="sales"     onclick="toggleCol(this)">Sales</button>
            <button class="pill cpill on" data-col="revenue"   onclick="toggleCol(this)">Revenue</button>
            <button class="pill cpill on" data-col="profit"    onclick="toggleCol(this)">Profit</button>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
          <button class="btn-ghost" onclick="resetFilters()">‚Ü∫ Reset Filters</button>
          <span id="resultCount" style="font-size:13px;color:var(--muted);"></span>
        </div>
      </div>

      <div class="card" style="padding:0;overflow:hidden;">
        <div class="twrap" id="salesWrap"><div class="nodata" style="padding:48px;">Apply a date range to view sales.</div></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ADMIN: Inventory View ‚îÄ‚îÄ -->
    <div class="page" id="page-inventory">
      <h2 class="section-heading">Inventory</h2>
      <p class="section-sub">View and update stock levels. Use the entry panel below to record transactions.</p>

      <!-- Admin Transaction Entry Panel -->
      <div class="txn-panel" id="adminTxnPanel">
        <div class="txn-title">üìù Record Transaction (Admin)</div>
        <div class="frow">
          <div class="fg"><label>Date</label><input type="date" id="invTxnDate" onchange="onInvDateChange()"></div>
          <div class="fg"><label>Category</label>
            <select id="invTxnCat" onchange="onInvCatChange()"><option value="">‚Äî Select Category ‚Äî</option></select>
          </div>
          <div class="fg" style="min-width:220px;"><label>Product</label>
            <select id="invTxnProd" onchange="onInvProdChange()" disabled><option value="">‚Äî Select Product ‚Äî</option></select>
          </div>
        </div>
        <div class="info-box" id="invInfoBox">
          <div class="info-grid">
            <div class="info-item"><div class="info-lbl">Opening</div><div class="info-val g" id="invIOpen">‚Äî</div></div>
            <div class="info-item"><div class="info-lbl">Purchases</div><div class="info-val b" id="invIPurch">‚Äî</div></div>
            <div class="info-item"><div class="info-lbl">Max Available</div><div class="info-val" id="invIMax">‚Äî</div></div>
            <div class="info-item"><div class="info-lbl">Closing</div><div class="info-val o" id="invIClose">‚Äî</div></div>
            <div class="info-item"><div class="info-lbl">Cost Price</div><div class="info-val" id="invICost">‚Äî</div></div>
            <div class="info-item"><div class="info-lbl">Sell Price</div><div class="info-val g" id="invISell">‚Äî</div></div>
          </div>
        </div>
        <div class="txn-type-row">
          <span style="font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;">Transaction Type:</span>
          <button class="ttype-btn t-closing" id="invbtn-closing" onclick="setInvTxnType('closing')">üì¶ Closing Stock</button>
          <button class="ttype-btn" id="invbtn-purchase" onclick="setInvTxnType('purchase')">üõí Add Purchase</button>
          <button class="ttype-btn" id="invbtn-opening" onclick="setInvTxnType('opening')">üîì Set Opening</button>
        </div>
        <div class="frow">
          <div class="fg"><label id="invQtyLabel">Closing Stock (units)</label>
            <input type="number" id="invTxnQty" min="0" placeholder="Enter quantity" style="min-width:180px;">
          </div>
          <div class="fg"><label>&nbsp;</label>
            <button class="btn-p" onclick="saveInvTxn()">‚úì Save Transaction</button>
          </div>
        </div>
      </div>

      <!-- Inventory Table Filters -->
      <div class="date-range-bar">
        <div class="fg"><label>View Date</label><input type="date" id="invDate" onchange="loadInventoryView()"></div>
        <div class="fg"><label>Category</label>
          <select id="invCatFilter" onchange="loadInventoryView()"><option value="">All Categories</option></select>
        </div>
        <div class="fg"><label>Search</label>
          <input type="text" id="invSearch" placeholder="Product name..." oninput="loadInventoryView()">
        </div>
      </div>

      <div class="stats-grid" id="invStats"></div>
      <div class="card" style="padding:0;overflow:hidden;">
        <div class="twrap" id="invWrap"><div class="nodata" style="padding:48px;">Select a date to view inventory.</div></div>
      </div>

      <!-- Transaction Log for selected date -->
      <div class="card" id="invLogCard" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px;">
          <h3 class="card-title" style="margin:0;" id="invLogTitle">Transaction Log</h3>
          <input class="fsearch" type="text" placeholder="üîç Filter log..." id="invLogSearch" oninput="renderInvLog()" style="max-width:240px;">
        </div>
        <div class="twrap" id="invLogWrap"><div class="nodata">No transactions for this date.</div></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ADMIN: Products ‚îÄ‚îÄ -->
    <div class="page" id="page-products">
      <h2 class="section-heading">Product Management</h2>
      <p class="section-sub">Manage categories and products.</p>

      <div class="card">
        <h3 class="card-title">üóÇÔ∏è Manage Categories</h3>
        <div class="frow" style="margin-bottom:14px;">
          <div class="fg" style="min-width:240px;"><label>New Category Name</label>
            <input type="text" id="newCatInput" placeholder="e.g. Dry Fruits" onkeydown="if(event.key==='Enter')addCategory()">
          </div>
          <div class="fg"><label>&nbsp;</label><button class="btn-p" onclick="addCategory()">+ Add Category</button></div>
        </div>
        <div id="catChips" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
      </div>

      <button class="btn-p" onclick="openAddProduct()" style="margin-bottom:16px;">+ Add New Product</button>
      <div class="card">
        <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;">
          <input class="fsearch" type="text" id="prodSearch" placeholder="üîç Search products..." oninput="renderProductTable()">
          <select id="prodCatFilter" style="padding:9px 12px;border:2px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;outline:none;background:#fff;" onchange="renderProductTable()">
            <option value="">All Categories</option>
          </select>
        </div>
        <div class="twrap" id="prodWrap"></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ADMIN: Settings ‚îÄ‚îÄ -->
    <div class="page" id="page-settings">
      <h2 class="section-heading">Admin Settings</h2>
      <div class="unlock-sec">
        <h3>üîì Unlock Staff Access After Hours</h3>
        <p style="font-size:13px;color:#856404;margin-bottom:14px;">Allow staff to update inventory after 11:59 PM for a specific date.</p>
        <div class="frow">
          <div class="fg"><label>Date to Unlock</label><input type="date" id="unlockDate"></div>
          <div class="fg"><label>&nbsp;</label><button class="btn-p" onclick="unlockDateFn()">üîì Unlock</button></div>
        </div>
        <div id="unlockedList" style="margin-top:10px;font-size:13px;"></div>
      </div>
      <div class="card">
        <h3 class="card-title">üîë Change Passwords</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;" class="pwgrid">
          <div>
            <div class="mrow"><label>New Admin Password</label><input type="password" id="newAdminPw" placeholder="Min 4 characters"></div>
            <button class="btn-s" onclick="changePw('admin')">Update Admin Password</button>
          </div>
          <div>
            <div class="mrow"><label>New Staff Password</label><input type="password" id="newStaffPw" placeholder="Min 4 characters"></div>
            <button class="btn-s" onclick="changePw('staff')">Update Staff Password</button>
          </div>
        </div>
      </div>

      <!-- Google Sheets Integration -->
      <div class="card" style="border:2px solid #34A853;background:linear-gradient(135deg,#F1F8E9,#fff);">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <img src="https://www.gstatic.com/images/branding/product/1x/sheets_2020q4_48dp.png" style="width:32px;height:32px;" onerror="this.style.display='none'">
          <h3 class="card-title" style="margin:0;color:#188038;">üìä Google Sheets Integration</h3>
        </div>
        <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">
          Syncs daily sales data (by product &amp; category) to your Google Sheet automatically.
          Two tabs will be created: <b>üìã Daily Sales</b> and <b>üìä Category Summary</b>.
        </p>

        <div class="mrow">
          <label>Apps Script Web App URL</label>
          <input type="text" id="sheetsUrl" placeholder="https://script.google.com/macros/s/.../exec"
            style="font-size:12px;font-family:monospace;"
            value="https://script.google.com/macros/s/AKfycbx45c7LKkUCLIWfIJUg0InOaTU1bFkAdd83Pr9enrpKOos6CBC-eFmOLAwOB5j0GQYs/exec">
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px;">
          <button class="btn-p" style="background:#188038;" onmouseover="this.style.background='#146c30'" onmouseout="this.style.background='#188038'" onclick="saveSheetsUrl()">üíæ Save URL</button>
          <button class="btn-s" style="border-color:#188038;color:#188038;" onclick="testSheetsConnection()">üîó Test Connection</button>
        </div>
        <div id="sheetsStatus" style="margin-top:12px;font-size:13px;min-height:20px;"></div>
      </div>
    </div>

  </main>
</div>

<!-- ‚ïê‚ïê‚ïê ADD PRODUCT MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-ov" id="addProdModal">
  <div class="modal">
    <h2>‚ûï Add New Product</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="mrow"><label>Product ID</label><input type="text" id="nProdId"></div>
      <div class="mrow"><label>Category</label><select id="nProdCat"><option value="">Select...</option></select></div>
    </div>
    <div class="mrow"><label>Product Name</label><input type="text" id="nProdName" placeholder="Product name"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="mrow"><label>Cost Price (‚Çπ)</label><input type="number" id="nProdCost" placeholder="0" min="0"></div>
      <div class="mrow"><label>Selling Price (‚Çπ)</label><input type="number" id="nProdPrice" placeholder="0" min="0"></div>
    </div>
    <div class="mrow"><label>Opening Stock</label><input type="number" id="nProdStock" placeholder="0" min="0"></div>
    <div class="mactions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-p" onclick="saveNewProduct()">Save Product</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA LAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SK={P:'ssf4_products',T:'ssf4_txns',U:'ssf4_unlocked',PW:'ssf4_pw',CC:'ssf4_custom_cats'};
const ls=k=>{try{return JSON.parse(localStorage.getItem(k));}catch{return null;}};
const ss=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

const BUILT_IN_CATS=['Hot','Non Veg Pickles','Others','Pickles','Powder','Sweets','Ulavacharu','Vadiyalu'];

const PRODUCTS=[
  {id:'P001',name:'Ulavacharu 500 Gm',cat:'Ulavacharu',cost:100,price:150,opening:33},
  {id:'P002',name:'Ulavacharu 250 Gm',cat:'Ulavacharu',cost:50,price:80,opening:5},
  {id:'P003',name:'Putharekulu',cat:'Sweets',cost:55,price:120,opening:9},
  {id:'P004',name:'Putharekulu Special',cat:'Sweets',cost:90,price:200,opening:1},
  {id:'P005',name:'Bellam Sunnundalu',cat:'Sweets',cost:0,price:150,opening:16},
  {id:'P006',name:'Kobbari Boorelu',cat:'Sweets',cost:100,price:180,opening:1},
  {id:'P007',name:'Ariselu',cat:'Sweets',cost:0,price:170,opening:2},
  {id:'P008',name:'Kajjikayalu',cat:'Sweets',cost:0,price:180,opening:0},
  {id:'P009',name:'Bellam Gavvalu',cat:'Sweets',cost:0,price:160,opening:9},
  {id:'P010',name:'Ragi Gavvalu',cat:'Sweets',cost:0,price:160,opening:0},
  {id:'P011',name:'Gulabi Puvvulu',cat:'Sweets',cost:0,price:60,opening:12},
  {id:'P012',name:'Maramaralu Undalu',cat:'Sweets',cost:0,price:50,opening:4},
  {id:'P013',name:'Palli Undalu',cat:'Sweets',cost:0,price:60,opening:22},
  {id:'P014',name:'Nuvvula Undalu',cat:'Sweets',cost:0,price:60,opening:25},
  {id:'P015',name:'Badam Biscuit',cat:'Sweets',cost:0,price:170,opening:0},
  {id:'P016',name:'Madugula Halwa',cat:'Sweets',cost:0,price:100,opening:0},
  {id:'P049',name:'Thati Thandra',cat:'Sweets',cost:0,price:150,opening:0},
  {id:'P050',name:'Mamidi Thandra',cat:'Sweets',cost:0,price:100,opening:6},
  {id:'P114',name:'Bobbatlu',cat:'Sweets',cost:0,price:60,opening:0},
  {id:'P115',name:'Badam Papidi',cat:'Sweets',cost:0,price:150,opening:0},
  {id:'P125',name:'Kobbari Undalu',cat:'Sweets',cost:0,price:60,opening:0},
  {id:'P017',name:'Majjiga Mirapakayalu',cat:'Vadiyalu',cost:0,price:100,opening:20},
  {id:'P018',name:'Minapa Vadiyalu',cat:'Vadiyalu',cost:0,price:0,opening:0},
  {id:'P019',name:'Pesarapappu Vadiyalu',cat:'Vadiyalu',cost:0,price:130,opening:13},
  {id:'P020',name:'Saggubiyyam Vadiyalu',cat:'Vadiyalu',cost:0,price:80,opening:20},
  {id:'P021',name:'Biyyam Pindi Vadiyalu',cat:'Vadiyalu',cost:0,price:80,opening:14},
  {id:'P022',name:'Corn Vadiyalu',cat:'Vadiyalu',cost:100,price:130,opening:23},
  {id:'P023',name:'Saggubiyyam Karam Vadiyalu',cat:'Vadiyalu',cost:0,price:80,opening:11},
  {id:'P024',name:'Onion Vadiyalu',cat:'Vadiyalu',cost:0,price:130,opening:16},
  {id:'P025',name:'Maramaralu',cat:'Hot',cost:0,price:50,opening:17},
  {id:'P026',name:'Saggubiyyam Chekkalu 250',cat:'Hot',cost:0,price:80,opening:0},
  {id:'P027',name:'Saggubiyyam Chekkalu 500',cat:'Hot',cost:0,price:160,opening:0},
  {id:'P028',name:'Onion Chekkalu',cat:'Hot',cost:0,price:80,opening:15},
  {id:'P029',name:'Palakura Chekkalu',cat:'Hot',cost:0,price:80,opening:13},
  {id:'P030',name:'Beet Root Chekkalu',cat:'Hot',cost:0,price:0,opening:0},
  {id:'P031',name:'Ribbon Pakodi',cat:'Hot',cost:0,price:80,opening:8},
  {id:'P032',name:'Butter Chakralu',cat:'Hot',cost:0,price:80,opening:6},
  {id:'P033',name:'Murukulu',cat:'Hot',cost:0,price:80,opening:10},
  {id:'P034',name:'Chekodilu 500',cat:'Hot',cost:0,price:160,opening:1},
  {id:'P035',name:'Sanna Karappusa',cat:'Hot',cost:0,price:0,opening:0},
  {id:'P036',name:'Vamppusa',cat:'Hot',cost:0,price:0,opening:0},
  {id:'P037',name:'Dal Mudi',cat:'Hot',cost:0,price:160,opening:2},
  {id:'P038',name:'Atukula Mixture',cat:'Hot',cost:0,price:80,opening:8},
  {id:'P039',name:'Boondi',cat:'Hot',cost:0,price:0,opening:0},
  {id:'P040',name:'Corn Flakes',cat:'Hot',cost:0,price:0,opening:0},
  {id:'P041',name:'Aloo Chips',cat:'Hot',cost:0,price:0,opening:0},
  {id:'P042',name:'Aloo Sticks',cat:'Hot',cost:0,price:0,opening:0},
  {id:'P043',name:'Green Batani Mixture',cat:'Hot',cost:0,price:160,opening:2},
  {id:'P044',name:'Navaratna Mixture',cat:'Hot',cost:0,price:160,opening:3},
  {id:'P045',name:'Batanilu 500gm',cat:'Hot',cost:0,price:130,opening:6},
  {id:'P046',name:'Senagalu 500',cat:'Hot',cost:0,price:130,opening:14},
  {id:'P047',name:'Pallilu 500gm',cat:'Hot',cost:0,price:130,opening:5},
  {id:'P048',name:'Chekodi 250 Gm',cat:'Hot',cost:0,price:80,opening:2},
  {id:'P116',name:'Palli Pakodi',cat:'Hot',cost:0,price:0,opening:0},
  {id:'P133',name:'Kakarakai Chips',cat:'Hot',cost:0,price:120,opening:0},
  {id:'P054',name:'Amla 500 Gm',cat:'Pickles',cost:115,price:160,opening:5},
  {id:'P055',name:'Amla 300 Gm',cat:'Pickles',cost:70,price:110,opening:3},
  {id:'P056',name:'Tomato 500 Gm',cat:'Pickles',cost:115,price:160,opening:8},
  {id:'P057',name:'Tomato 300Gm',cat:'Pickles',cost:70,price:110,opening:6},
  {id:'P058',name:'Mango 500 Gm',cat:'Pickles',cost:115,price:200,opening:7},
  {id:'P059',name:'Mango 300 Gm',cat:'Pickles',cost:70,price:110,opening:10},
  {id:'P060',name:'Gongura 500 Gm',cat:'Pickles',cost:115,price:160,opening:8},
  {id:'P061',name:'Gongura 300 Gm',cat:'Pickles',cost:70,price:110,opening:8},
  {id:'P062',name:'Lemon 500 Gm',cat:'Pickles',cost:115,price:160,opening:9},
  {id:'P063',name:'Lemon 300 Gm',cat:'Pickles',cost:70,price:110,opening:8},
  {id:'P064',name:'Red Chilli 500 Gm',cat:'Pickles',cost:115,price:160,opening:8},
  {id:'P065',name:'Red Chilli 300 Gm',cat:'Pickles',cost:70,price:110,opening:11},
  {id:'P066',name:'Ginger 500Gm',cat:'Pickles',cost:115,price:160,opening:9},
  {id:'P067',name:'Ginger 300 Gm',cat:'Pickles',cost:70,price:110,opening:5},
  {id:'P068',name:'Pudina 500 Gm',cat:'Pickles',cost:115,price:160,opening:2},
  {id:'P069',name:'Pudina 300 Gm',cat:'Pickles',cost:70,price:110,opening:4},
  {id:'P070',name:'Drum Sticks 500 Gm',cat:'Pickles',cost:115,price:160,opening:2},
  {id:'P071',name:'Drum Sticks 300 Gm',cat:'Pickles',cost:70,price:110,opening:4},
  {id:'P072',name:'Kothimeera 500 Gm',cat:'Pickles',cost:115,price:170,opening:2},
  {id:'P073',name:'Kothimeera 300 Gm',cat:'Pickles',cost:70,price:110,opening:4},
  {id:'P117',name:'Tamarind 250 Gm',cat:'Pickles',cost:0,price:110,opening:5},
  {id:'P118',name:'Tamarind 500 Gm',cat:'Pickles',cost:0,price:150,opening:1},
  {id:'P074',name:'Karivepaku 100 Gm',cat:'Powder',cost:35,price:60,opening:0},
  {id:'P075',name:'Karivepaku Karam 250 Gm',cat:'Powder',cost:105,price:160,opening:0},
  {id:'P076',name:'Nallakaram 100 Gm',cat:'Powder',cost:35,price:60,opening:0},
  {id:'P077',name:'Nallakaram 500 Gm',cat:'Powder',cost:105,price:160,opening:5},
  {id:'P078',name:'Munagaku Karam 100',cat:'Powder',cost:35,price:60,opening:0},
  {id:'P079',name:'Munagaku Karam 250 Gm',cat:'Powder',cost:105,price:160,opening:0},
  {id:'P080',name:'Idly Karam 100 Gm',cat:'Powder',cost:35,price:60,opening:0},
  {id:'P081',name:'Idly Karam 250 Gm',cat:'Powder',cost:105,price:160,opening:0},
  {id:'P082',name:'Kandi Karam 100 Gm',cat:'Powder',cost:35,price:60,opening:0},
  {id:'P083',name:'Kandi Karam 250 Gm',cat:'Powder',cost:105,price:160,opening:0},
  {id:'P084',name:'Kobbari Karam 100 Gm',cat:'Powder',cost:35,price:60,opening:0},
  {id:'P085',name:'Kobbari Karam 250 Gm',cat:'Powder',cost:105,price:160,opening:0},
  {id:'P086',name:'Flax Seed Karam 100 Gm',cat:'Powder',cost:35,price:60,opening:0},
  {id:'P087',name:'Flax Seed Karam 250 Gm',cat:'Powder',cost:105,price:160,opening:0},
  {id:'P088',name:'Nuvvula Karam 100 Gm',cat:'Powder',cost:35,price:60,opening:0},
  {id:'P089',name:'Nuvvula Karam 250 Gm',cat:'Powder',cost:105,price:160,opening:0},
  {id:'P090',name:'Putnala Karam 100 Gm',cat:'Powder',cost:35,price:60,opening:0},
  {id:'P091',name:'Putnala Karam 250 Gm',cat:'Powder',cost:105,price:160,opening:0},
  {id:'P092',name:'Kakarakaya Karam 100 Gm',cat:'Powder',cost:35,price:60,opening:0},
  {id:'P093',name:'Kakarakaya Karam 250 Gm',cat:'Powder',cost:105,price:160,opening:0},
  {id:'P094',name:'Pudina Karam 100 Gm',cat:'Powder',cost:35,price:60,opening:0},
  {id:'P095',name:'Pudina Karam 250 Gm',cat:'Powder',cost:105,price:160,opening:0},
  {id:'P119',name:'Pallila Karam 100',cat:'Powder',cost:0,price:0,opening:0},
  {id:'P120',name:'Pallila Karam 250',cat:'Powder',cost:0,price:0,opening:0},
  {id:'P121',name:'Avesa Ginjala Karam 100',cat:'Powder',cost:0,price:0,opening:0},
  {id:'P122',name:'Avesa Ginjala Karam 250',cat:'Powder',cost:0,price:0,opening:0},
  {id:'P123',name:'Vellulli Karam 100',cat:'Powder',cost:0,price:0,opening:0},
  {id:'P124',name:'Vellulli Karam 250',cat:'Powder',cost:0,price:0,opening:0},
  {id:'P096',name:'Nethallu 250 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P097',name:'Nethallu 500 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P098',name:'Chicken Bone 250 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P099',name:'Chicken Bone 500 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P100',name:'Chicken Boneless 500 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P101',name:'Chicken Boneless 250 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P102',name:'Gongura Chicken 500 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P103',name:'Gongura Chicken 250 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P104',name:'Prawn 250 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P105',name:'Gongura Prawn 500 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P106',name:'Mutton Keema 500 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P107',name:'Prawn 500 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P108',name:'Gongura Prawn 250 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P109',name:'Mutton Keema 250 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P110',name:'Natukodi 250 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P111',name:'Natukodi 500 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P112',name:'Mutton 250 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P113',name:'Mutton 500 Gm',cat:'Non Veg Pickles',cost:0,price:0,opening:0},
  {id:'P051',name:'Corn Samosa',cat:'Others',cost:0,price:0,opening:0},
  {id:'P052',name:'Mushrooms',cat:'Others',cost:0,price:0,opening:0},
  {id:'P053',name:'Veg Rolls',cat:'Others',cost:0,price:0,opening:0},
  {id:'P126',name:'Horlicks Biscuits',cat:'Others',cost:0,price:55,opening:0},
  {id:'P127',name:'Nimma Thonalu',cat:'Others',cost:0,price:60,opening:0},
  {id:'P128',name:'Nimma Thonalu Chinnavi',cat:'Others',cost:0,price:60,opening:0},
  {id:'P129',name:'Roasted Natu Pallilu',cat:'Others',cost:0,price:60,opening:0},
  {id:'P130',name:'Batanilu',cat:'Others',cost:0,price:60,opening:0},
  {id:'P131',name:'Senagalu',cat:'Others',cost:0,price:60,opening:0},
  {id:'P132',name:'Cherries',cat:'Others',cost:0,price:60,opening:0},
];

function initData(){
  if(!ls(SK.P)) ss(SK.P,PRODUCTS);
  if(!ls(SK.T)) ss(SK.T,{});
  if(!ls(SK.U)) ss(SK.U,[]);
  if(!ls(SK.PW)) ss(SK.PW,{admin:'admin123',staff:'staff123'});
  if(!ls(SK.CC)) ss(SK.CC,[]);
}
const getProds=()=>ls(SK.P)||PRODUCTS;
const getTxns=()=>ls(SK.T)||{};
const getUnlocked=()=>ls(SK.U)||[];
const getPws=()=>ls(SK.PW)||{admin:'admin123',staff:'staff123'};
const getCustomCats=()=>ls(SK.CC)||[];
const getAllCats=()=>[...new Set([...BUILT_IN_CATS,...getCustomCats()])].sort();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let role=null;
function selectRole(r){
  role=r;
  document.querySelectorAll('.role-tab').forEach((t,i)=>t.classList.toggle('active',(i===0&&r==='admin')||(i===1&&r==='staff')));
  document.getElementById('loginPw').value='';
  document.getElementById('loginErr').textContent='';
}
function doLogin(){
  const pw=document.getElementById('loginPw').value;
  const pws=getPws();
  if(!role){document.getElementById('loginErr').textContent='Please select a role.';return;}
  if(pw!==pws[role]){document.getElementById('loginErr').textContent='Incorrect password.';return;}
  startApp();
}
function doLogout(){
  role=null;
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('appScreen').style.display='none';
  document.getElementById('loginPw').value='';
}
function startApp(){
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('appScreen').style.display='flex';
  const rb=document.getElementById('roleBadge');
  rb.textContent=role==='admin'?'üëë Admin':'üßë‚Äçüíº Staff';
  rb.className='rbadge '+role;
  buildNav();
  startClock();
  populateAllDropdowns();
  setToday();
  if(role==='admin'){
    showPage('sales');
    loadSalesReport();
    renderProductTable();
    renderCatChips();
    renderUnlockedList();
    populateInvCatFilter();
    // set inv txn date to today
    const itd=document.getElementById('invTxnDate'); if(itd) itd.value=todayStr();
    const ivd=document.getElementById('invDate'); if(ivd) ivd.value=todayStr();
    // pre-fill sheets URL input if saved
    const sui=document.getElementById('sheetsUrl');
    if(sui){ const saved=getSheetsUrl(); if(saved) sui.value=saved; }
  } else {
    showPage('update');
    populateStaffCatFilter();
    renderStaffTable();
    updateStaffProgress(todayStr());
  }
}
function buildNav(){
  const tabs=role==='admin'
    ?[{id:'sales',l:'üìä Sales Report'},{id:'inventory',l:'üì¶ Inventory'},{id:'products',l:'üõí Products'},{id:'settings',l:'‚öôÔ∏è Settings'}]
    :[{id:'update',l:'‚úèÔ∏è Update Inventory'}];
  document.getElementById('navTabs').innerHTML=tabs.map(t=>`<button class="nav-tab" id="tab-${t.id}" onclick="showPage('${t.id}')">${t.l}</button>`).join('');
}
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  const p=document.getElementById('page-'+id); if(p) p.classList.add('active');
  const t=document.getElementById('tab-'+id); if(t) t.classList.add('active');
  if(id==='inventory') loadInventoryView();
  if(id==='products'){renderCatChips();renderProductTable();}
}
function todayStr(){return new Date().toISOString().split('T')[0];}
function setToday(){
  const d=todayStr();
  const el=document.getElementById('txnDate'); if(el) el.value=d;
  const sf=document.getElementById('salesFrom'); if(sf) sf.value=d;
  const st=document.getElementById('salesTo'); if(st) st.value=d;
  const iv=document.getElementById('invDate'); if(iv) iv.value=d;
  const ul=document.getElementById('unlockDate'); if(ul) ul.value=d;
}
function startClock(){
  const tick=()=>{const el=document.getElementById('clockEl');if(el)el.textContent=new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'});};
  tick();setInterval(tick,1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DROPDOWNS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateAllDropdowns(){
  const cats=getAllCats();
  const catOpts='<option value="">‚Äî Select Category ‚Äî</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  const allOpts='<option value="">All Categories</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  // admin inv txn category
  const ic=document.getElementById('invTxnCat'); if(ic) ic.innerHTML=catOpts;
  // new product modal
  const nc=document.getElementById('nProdCat'); if(nc) nc.innerHTML='<option value="">Select...</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  // product page filter
  const pcf=document.getElementById('prodCatFilter'); if(pcf) pcf.innerHTML=allOpts;
}
function populateInvCatFilter(){
  const cats=getAllCats();
  const el=document.getElementById('invCatFilter');
  if(el) el.innerHTML='<option value="">All Categories</option>'+cats.map(c=>`<option value="${c}">${c}</option>`).join('');
}
function buildCatPills(){
  const wrap=document.getElementById('catPills');
  if(!wrap) return;
  const cats=getAllCats();
  wrap.innerHTML=`<button class="pill on" data-grp="cat" data-val="all" onclick="setPill(this,'cat')">All Categories</button>`
    +cats.map(c=>`<button class="pill" data-grp="cat" data-val="${c}" onclick="setPill(this,'cat')">${c}</button>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getState(pid,date){
  const txns=getTxns();
  const day=(txns[date]||[]).filter(t=>t.pid===pid);
  const opTxn=[...day].reverse().find(t=>t.type==='opening');
  const opening=opTxn!=null?opTxn.qty:getPrevClose(pid,date);
  const purchases=day.filter(t=>t.type==='purchase').reduce((s,t)=>s+t.qty,0);
  const clTxn=[...day].reverse().find(t=>t.type==='closing');
  const closing=clTxn!=null?clTxn.qty:null;
  return{opening,purchases,closing,max:opening+purchases};
}
function getPrevClose(pid,date){
  const txns=getTxns();
  const dates=Object.keys(txns).filter(d=>d<date).sort().reverse();
  for(const d of dates){
    const cl=[...(txns[d]||[])].reverse().find(t=>t.pid===pid&&t.type==='closing');
    if(cl!=null) return cl.qty;
    const op=[...(txns[d]||[])].reverse().find(t=>t.pid===pid&&t.type==='opening');
    if(op!=null) return op.qty;
  }
  const p=getProds().find(x=>x.id===pid);
  return p?(p.opening||0):0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isLocked(){const n=new Date();return n.getHours()===23&&n.getMinutes()>=59;}
function checkLock(){
  const date=(document.getElementById('txnDate')||{}).value||todayStr();
  const locked=isLocked()&&!getUnlocked().includes(date);
  const b=document.getElementById('lockBanner'); if(b) b.classList.toggle('on',locked);
  const sb=document.getElementById('submitBtn'); if(sb) sb.disabled=locked;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STAFF ‚Äì TABLE-BASED INVENTORY UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onStaffDateChange(){
  const date=(document.getElementById('txnDate')||{}).value||'';
  checkLock();
  renderStaffTable();
  updateStaffProgress(date);
}

function populateStaffCatFilter(){
  const el=document.getElementById('staffCatFilter'); if(!el) return;
  const cats=getAllCats();
  el.innerHTML='<option value="">All Categories</option>'
    +cats.map(c=>`<option value="${c}">${c}</option>`).join('');
}

// stock filter state
let activeStockPill='all';
function setStockPill(btn){
  document.querySelectorAll('.spill').forEach(p=>p.classList.remove('on'));
  btn.classList.add('on');
  activeStockPill=btn.dataset.stock;
  renderStaffTable();
}
function clearStockRange(){
  const mn=document.getElementById('stockMin'); if(mn) mn.value='';
  const mx=document.getElementById('stockMax'); if(mx) mx.value='';
  renderStaffTable();
}

function renderStaffTable(){
  const date=(document.getElementById('txnDate')||{}).value||'';
  const cat=(document.getElementById('staffCatFilter')||{}).value||'';
  const q=((document.getElementById('staffSearch')||{}).value||'').toLowerCase();
  const stockMode=activeStockPill||'all';
  const stockMinVal=(document.getElementById('stockMin')||{}).value||'';
  const stockMaxVal=(document.getElementById('stockMax')||{}).value||'';
  const stockMin=stockMinVal!==''?parseInt(stockMinVal):null;
  const stockMax=stockMaxVal!==''?parseInt(stockMaxVal):null;
  const wrap=document.getElementById('staffTableWrap'); if(!wrap) return;
  const submitBar=document.getElementById('staffSubmitBar');

  if(!date){
    wrap.innerHTML='<div class="nodata" style="padding:48px;">Select a date to begin entering closing stock.</div>';
    if(submitBar) submitBar.style.display='none';
    return;
  }

  let prods=getProds();
  if(cat) prods=prods.filter(p=>p.cat===cat);
  if(q) prods=prods.filter(p=>p.name.toLowerCase().includes(q)||p.id.toLowerCase().includes(q));

  // Apply stock filters (need state for each product)
  let rows=prods.map(p=>{const st=getState(p.id,date);return{...p,...st};});
  if(stockMode==='instock')  rows=rows.filter(r=>r.max>0);
  if(stockMode==='outstock') rows=rows.filter(r=>r.max===0);
  if(stockMin!==null) rows=rows.filter(r=>r.max>=stockMin);
  if(stockMax!==null) rows=rows.filter(r=>r.max<=stockMax);

  if(!rows.length){
    wrap.innerHTML='<div class="nodata" style="padding:48px;">No products match the current filters.</div>';
    if(submitBar) submitBar.style.display='block';
    updateStaffProgress(date);
    return;
  }

  // Show active filter summary chip if any stock filter is on
  let filterChips='';
  if(stockMode!=='all') filterChips+=`<span style="background:var(--sl);color:var(--sd);padding:2px 10px;border-radius:20px;font-size:11px;font-weight:600;margin-right:4px;">${stockMode==='instock'?'‚úÖ In Stock':'‚ùå Out of Stock'}</span>`;
  if(stockMin!==null) filterChips+=`<span style="background:var(--bl);color:var(--blue);padding:2px 10px;border-radius:20px;font-size:11px;font-weight:600;margin-right:4px;">‚â• ${stockMin}</span>`;
  if(stockMax!==null) filterChips+=`<span style="background:var(--bl);color:var(--blue);padding:2px 10px;border-radius:20px;font-size:11px;font-weight:600;margin-right:4px;">‚â§ ${stockMax}</span>`;

  // Sticky submit bar
  if(submitBar) submitBar.style.display='block';
  updateStaffProgress(date);

  // Group rows by category for section headers
  const byCategory={};
  rows.forEach(r=>{
    if(!byCategory[r.cat]) byCategory[r.cat]=[];
    byCategory[r.cat].push(r);
  });

  const sd=document.getElementById('submitDate');
  if(sd) sd.textContent='Date: '+fmtDate(date)+' ¬∑ '+rows.length+' product'+(rows.length!==1?'s':'');

  let h=`<table>
    <thead>
      ${filterChips?`<tr style="background:#FFFBF5;">
        <td colspan="6" style="padding:7px 14px;border-bottom:1px solid var(--border);">
          <span style="font-size:11px;font-weight:700;color:var(--muted);margin-right:6px;text-transform:uppercase;letter-spacing:.5px;">Filters:</span>
          ${filterChips}
        </td>
      </tr>`:''}
      <tr>
        <th style="min-width:200px;">Product</th>
        <th style="text-align:center;min-width:80px;">Opening</th>
        <th style="text-align:center;min-width:80px;">Purchases</th>
        <th style="text-align:center;min-width:90px;">Available</th>
        <th style="text-align:center;min-width:110px;">
          Closing Stock
          <div style="font-size:10px;font-weight:400;color:#aaa;text-transform:none;letter-spacing:0;">Type & press Enter ‚Üµ</div>
        </th>
        <th style="text-align:center;min-width:70px;">Status</th>
      </tr>
    </thead><tbody>`;

  Object.entries(byCategory).forEach(([catName, catRows])=>{
    // Category header row
    h+=`<tr style="background:linear-gradient(90deg,#F5F0EB,#FAFAF7);">
      <td colspan="6" style="padding:8px 14px;font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.8px;color:var(--sd);">
        üóÇ ${catName} <span style="font-weight:400;color:var(--muted);font-size:11px;">(${catRows.filter(r=>r.closing!=null).length}/${catRows.length} done)</span>
      </td>
    </tr>`;

    catRows.forEach(r=>{
      const isDone=r.closing!=null;
      const availColor=r.max===0?'var(--red)':r.max<=5?'#E65100':'var(--text)';
      const statusBadge=isDone
        ?`<span style="background:var(--gl);color:var(--green);padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;">‚úì Done</span>`
        :`<span style="background:#FFF3E0;color:var(--sd);padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;">Pending</span>`;

      const inputStyle=isDone
        ?`border-color:var(--green);color:var(--green);font-weight:700;background:#F1F8E9;`
        :`border-color:var(--border);`;

      h+=`<tr id="srow_${r.id}" style="background:${isDone?'#FAFFFE':'#fff'};">
        <td>
          <div class="pname" style="font-size:14px;">${r.name}</div>
          <div class="pid">${r.id}</div>
        </td>
        <td style="text-align:center;color:var(--muted);">${r.opening}</td>
        <td style="text-align:center;color:var(--blue);">${r.purchases>0?'<b>+'+r.purchases+'</b>':r.purchases}</td>
        <td style="text-align:center;font-weight:700;color:${availColor};">${r.max}</td>
        <td style="text-align:center;">
          <input type="number" min="0" max="${r.max}"
            id="sclose_${r.id}"
            value="${isDone ? r.closing : ''}"
            placeholder="${r.max}"
            style="width:80px;padding:7px 8px;border:2px solid;border-radius:8px;font-size:15px;font-family:'DM Sans',sans-serif;outline:none;text-align:center;${inputStyle}"
            onfocus="this.style.borderColor='var(--saffron)';this.style.background='#fff';"
            onblur="staffCellBlur('${r.id}','${date}',this)"
            onkeydown="if(event.key==='Enter'){event.preventDefault();staffCellSave('${r.id}','${date}',this.value);staffFocusNext('${r.id}');}">
        </td>
        <td style="text-align:center;">${statusBadge}</td>
      </tr>`;
    });
  });

  h+=`</tbody></table>`;
  wrap.innerHTML=h;
}

function staffCellBlur(pid, date, input){
  // Auto-save when user clicks away from a filled cell
  if(input.value !== '') staffCellSave(pid, date, input.value, false);
}

function staffCellSave(pid, date, val, showToast=true){
  const qty=parseInt(val);
  if(val===''||isNaN(qty)||qty<0) return;
  const st=getState(pid,date);
  if(qty>st.max){
    toast('Closing ('+qty+') cannot exceed available ('+st.max+')','err');
    const inp=document.getElementById('sclose_'+pid); if(inp){inp.value=st.max;inp.style.borderColor='var(--red)';}
    return false;
  }
  // Save transaction
  const txns=getTxns();
  if(!txns[date]) txns[date]=[];
  txns[date]=txns[date].filter(t=>!(t.pid===pid&&t.type==='closing'));
  txns[date].push({pid,type:'closing',qty,ts:Date.now()});
  ss(SK.T,txns);

  // Update this row's UI in-place (no full re-render)
  const row=document.getElementById('srow_'+pid);
  if(row){
    row.style.background='#FAFFFE';
    const inp=document.getElementById('sclose_'+pid);
    if(inp){inp.style.borderColor='var(--green)';inp.style.color='var(--green)';inp.style.fontWeight='700';inp.style.background='#F1F8E9';}
    // update status badge cell
    const cells=row.querySelectorAll('td');
    if(cells[5]) cells[5].innerHTML='<span style="background:var(--gl);color:var(--green);padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;">‚úì Done</span>';
  }

  updateStaffProgress(date);
  if(showToast) toast('‚úì Saved','ok');
  return true;
}

function staffFocusNext(pid){
  // Move focus to next product's input
  const allInputs=Array.from(document.querySelectorAll('[id^="sclose_"]'));
  const idx=allInputs.findIndex(i=>i.id==='sclose_'+pid);
  if(idx>=0&&idx<allInputs.length-1) allInputs[idx+1].focus();
}

function updateStaffProgress(date){
  if(!date) return;
  const allProds=getProds();
  const total=allProds.length;
  const done=allProds.filter(p=>getState(p.id,date).closing!=null).length;
  const pct=total>0?Math.round(done/total*100):0;

  const bar=document.getElementById('staffProgressBar'); if(bar) bar.style.width=pct+'%';
  const prog=document.getElementById('staffProgress');
  if(prog) prog.textContent=done+' / '+total+' products done ('+pct+'%)';
  const sumEl=document.getElementById('submitSummary');
  if(sumEl) sumEl.textContent=done+' product'+(done!==1?'s':'')+' updated';
}

function submitAllData(){
  const date=(document.getElementById('txnDate')||{}).value||'';
  if(!date){toast('Select a date first','err');return;}

  const prods=getProds();
  const updated=prods.filter(p=>getState(p.id,date).closing!=null);

  if(!updated.length){
    toast('No closing stock entered yet ‚Äî fill in at least one product','err');
    return;
  }

  // Save a submission record
  const subKey='ssf4_submissions';
  const subs=ls(subKey)||[];
  const existing=subs.findIndex(s=>s.date===date);
  const record={
    date,
    submittedAt:Date.now(),
    updatedCount:updated.length,
    totalCount:prods.length
  };
  if(existing>=0) subs[existing]=record; else subs.push(record);
  ss(subKey,subs);

  // Visual confirmation
  const submitBtn=document.getElementById('submitBtn');
  if(submitBtn){
    submitBtn.textContent='‚úÖ Submitted!';
    submitBtn.style.background='#1B5E20';
    setTimeout(()=>{
      submitBtn.textContent='‚úÖ Submit Day\'s Data';
      submitBtn.style.background='var(--green)';
    },3000);
  }

  renderSubmissionLog(date);
  toast(`‚úÖ Day submitted! ${updated.length} of ${prods.length} products recorded.`,'ok');
}

function renderSubmissionLog(date){
  const card=document.getElementById('submissionCard'); if(!card) return;
  card.style.display='block';
  const wrap=document.getElementById('submissionLog'); if(!wrap) return;
  const prods=getProds();
  const rows=prods.map(p=>{
    const st=getState(p.id,date);
    return{...p,...st,sales:st.closing!=null?Math.max(0,st.max-st.closing):null};
  });
  const updated=rows.filter(r=>r.closing!=null);
  const pending=rows.filter(r=>r.closing==null);
  const totalRev=updated.reduce((s,r)=>s+(r.sales!=null&&r.price?r.sales*r.price:0),0);

  let h=`<div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px;">
    <div style="background:var(--gl);color:var(--green);padding:10px 20px;border-radius:10px;font-weight:700;">‚úÖ ${updated.length} products submitted</div>
    ${pending.length?`<div style="background:#FFF3E0;color:var(--sd);padding:10px 20px;border-radius:10px;font-weight:700;">‚è≥ ${pending.length} pending</div>`:''}
    <div style="background:var(--bl);color:var(--blue);padding:10px 20px;border-radius:10px;font-weight:700;">üí∞ Est. Revenue: ‚Çπ${totalRev.toLocaleString('en-IN')}</div>
  </div>`;

  if(pending.length){
    h+=`<div style="font-size:13px;color:var(--muted);margin-bottom:8px;font-weight:600;">Pending products:</div>`;
    h+=`<div style="display:flex;flex-wrap:wrap;gap:6px;">`;
    pending.forEach(r=>{
      h+=`<span style="background:#f5f5f5;border:1px solid #ddd;padding:4px 10px;border-radius:20px;font-size:12px;">${r.name}</span>`;
    });
    h+=`</div>`;
  }
  wrap.innerHTML=h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äì SALES REPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let salesRows=[];
let activeCat='all', activeStatus='all';
const visCols=new Set(['cat','cost','price','opening','purchases','closing','sales','revenue','profit']);

function setQuick(mode,btn){
  document.querySelectorAll('.qbtn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  const now=new Date();
  const d=(d)=>d.toISOString().split('T')[0];
  const sf=document.getElementById('salesFrom');
  const st=document.getElementById('salesTo');
  if(!sf||!st) return;
  if(mode==='today'){sf.value=st.value=d(now);}
  else if(mode==='yesterday'){const y=new Date(now);y.setDate(y.getDate()-1);sf.value=st.value=d(y);}
  else if(mode==='week'){const s=new Date(now);s.setDate(s.getDate()-s.getDay());sf.value=d(s);st.value=d(now);}
  else if(mode==='month'){const s=new Date(now.getFullYear(),now.getMonth(),1);sf.value=d(s);st.value=d(now);}
  // custom = let user type
  if(mode!=='custom') loadSalesReport();
}
function onSalesDateChange(){
  document.querySelectorAll('.qbtn').forEach(b=>b.classList.remove('on'));
  const cb=document.querySelector('.qbtn:last-child'); if(cb) cb.classList.add('on');
}
function loadSalesReport(){
  const from=(document.getElementById('salesFrom')||{}).value||todayStr();
  const to=(document.getElementById('salesTo')||{}).value||from;
  if(from>to){toast('From date must be ‚â§ To date','err');return;}
  // get all dates in range
  const dates=getDatesInRange(from,to);
  const prods=getProds();
  // aggregate across range: sum sales, revenue, profit per product
  const agg={};
  prods.forEach(p=>{
    agg[p.id]={...p,opening:0,purchases:0,closing:null,sales:0,revenue:0,profit:0,days:0};
  });
  dates.forEach(date=>{
    prods.forEach(p=>{
      const st=getState(p.id,date);
      const sales=st.closing!=null?Math.max(0,st.max-st.closing):null;
      if(sales!=null){
        agg[p.id].sales+=sales;
        agg[p.id].revenue+=p.price?sales*p.price:0;
        agg[p.id].profit+=p.price&&p.cost?sales*(p.price-p.cost):0;
        agg[p.id].days++;
      }
      agg[p.id].purchases+=st.purchases;
      // last closing
      if(date===to) agg[p.id].closing=st.closing;
      if(date===from) agg[p.id].opening=st.opening;
    });
  });
  salesRows=Object.values(agg);
  renderSalesStats();
  buildCatPills();
  filterSales();
}
function getDatesInRange(from,to){
  const dates=[];
  let cur=new Date(from+'T00:00:00');
  const end=new Date(to+'T00:00:00');
  while(cur<=end){dates.push(cur.toISOString().split('T')[0]);cur.setDate(cur.getDate()+1);}
  return dates;
}
function renderSalesStats(){
  const wrap=document.getElementById('salesStats'); if(!wrap) return;
  const tU=salesRows.reduce((s,r)=>s+r.sales,0);
  const tR=salesRows.reduce((s,r)=>s+r.revenue,0);
  const tP=salesRows.reduce((s,r)=>s+r.profit,0);
  const upd=salesRows.filter(r=>r.closing!=null).length;
  wrap.innerHTML=`
    <div class="stat-card"><div class="slbl">Units Sold</div><div class="sval" style="color:var(--saffron);">${tU}</div></div>
    <div class="stat-card"><div class="slbl">Revenue</div><div class="sval" style="color:var(--green);">‚Çπ${tR.toLocaleString('en-IN')}</div></div>
    <div class="stat-card"><div class="slbl">Gross Profit</div><div class="sval" style="color:var(--blue);">‚Çπ${tP.toLocaleString('en-IN')}</div></div>
    <div class="stat-card"><div class="slbl">Products Updated</div><div class="sval">${upd}</div></div>`;
}
function setPill(btn,grp){
  document.querySelectorAll(`.pill[data-grp="${grp}"]`).forEach(p=>p.classList.remove('on'));
  btn.classList.add('on');
  if(grp==='status') activeStatus=btn.dataset.val;
  if(grp==='cat') activeCat=btn.dataset.val;
  filterSales();
}
function toggleCol(btn){
  const col=btn.dataset.col;
  if(visCols.has(col)){visCols.delete(col);btn.classList.remove('on');}
  else{visCols.add(col);btn.classList.add('on');}
  filterSales();
}
function resetFilters(){
  const si=document.getElementById('salesSearch'); if(si) si.value='';
  activeCat='all'; activeStatus='all';
  document.querySelectorAll('.pill[data-grp]').forEach(p=>{
    p.classList.toggle('on',p.dataset.val==='all');
  });
  visCols.clear();
  ['cat','cost','price','opening','purchases','closing','sales','revenue','profit'].forEach(c=>visCols.add(c));
  document.querySelectorAll('.cpill').forEach(p=>p.classList.add('on'));
  filterSales();
}
function filterSales(){
  const q=((document.getElementById('salesSearch')||{}).value||'').toLowerCase();
  let rows=salesRows;
  if(q) rows=rows.filter(r=>r.name.toLowerCase().includes(q)||r.id.toLowerCase().includes(q));
  if(activeCat!=='all') rows=rows.filter(r=>r.cat===activeCat);
  if(activeStatus==='sold') rows=rows.filter(r=>r.sales>0);
  if(activeStatus==='notsold') rows=rows.filter(r=>r.sales===0);
  const rc=document.getElementById('resultCount'); if(rc) rc.textContent=rows.length+' product'+(rows.length!==1?'s':'');
  renderSalesTable(rows);
}
function renderSalesTable(rows){
  const wrap=document.getElementById('salesWrap'); if(!wrap) return;
  if(!rows||!rows.length){wrap.innerHTML='<div class="nodata" style="padding:48px;">No matching products.</div>';return;}
  const v=visCols;
  const th=(k,lbl,a='left')=>v.has(k)?`<th style="text-align:${a};">${lbl}</th>`:'';
  const td=(k,html)=>v.has(k)?`<td>${html}</td>`:'';
  const tU=rows.reduce((s,r)=>s+r.sales,0);
  const tR=rows.reduce((s,r)=>s+r.revenue,0);
  const tP=rows.reduce((s,r)=>s+r.profit,0);
  let h=`<table><thead><tr>
    <th>Product</th>
    ${th('cat','Category')}${th('cost','Cost','right')}${th('price','Price','right')}
    ${th('opening','Opening','center')}${th('purchases','Purchases','center')}${th('closing','Closing','center')}
    ${th('sales','Sales','center')}${th('revenue','Revenue','right')}${th('profit','Profit','right')}
  </tr></thead><tbody>`;
  rows.forEach(r=>{
    h+=`<tr>
      <td><div class="pname">${r.name}</div><div class="pid">${r.id}</div></td>
      ${td('cat',`<span class="cbadge">${r.cat}</span>`)}
      ${td('cost',`<div style="text-align:right;">${r.cost?'‚Çπ'+r.cost:'<span style="color:#ccc">‚Äî</span>'}</div>`)}
      ${td('price',`<div style="text-align:right;font-weight:600;color:var(--green);">${r.price?'‚Çπ'+r.price:'<span style="color:#ccc">‚Äî</span>'}</div>`)}
      ${td('opening',`<div style="text-align:center;">${r.opening}</div>`)}
      ${td('purchases',`<div style="text-align:center;">${r.purchases}</div>`)}
      ${td('closing',`<div style="text-align:center;">${r.closing!=null?r.closing:'<span style="color:#ccc">‚Äî</span>'}</div>`)}
      ${td('sales',`<div style="text-align:center;font-weight:700;color:var(--saffron);">${r.sales}</div>`)}
      ${td('revenue',`<div style="text-align:right;font-weight:700;color:var(--green);">${r.revenue?'‚Çπ'+r.revenue.toLocaleString('en-IN'):'<span style="color:#ccc">‚Äî</span>'}</div>`)}
      ${td('profit',`<div style="text-align:right;font-weight:700;color:var(--blue);">${r.profit?'‚Çπ'+r.profit.toLocaleString('en-IN'):'<span style="color:#ccc">‚Äî</span>'}</div>`)}
    </tr>`;
  });
  // totals row
  const nonNum=['cat','cost','price','opening','purchases','closing'].filter(c=>v.has(c)).length;
  h+=`<tr class="sum-row">
    <td style="text-align:right;" colspan="${1+nonNum}">TOTAL</td>
    ${v.has('sales')?`<td style="text-align:center;">${tU}</td>`:''}
    ${v.has('revenue')?`<td style="text-align:right;">‚Çπ${tR.toLocaleString('en-IN')}</td>`:''}
    ${v.has('profit')?`<td style="text-align:right;">‚Çπ${tP.toLocaleString('en-IN')}</td>`:''}
  </tr>`;
  h+='</tbody></table>';
  wrap.innerHTML=h;
}

function exportCSV(){
  const from=(document.getElementById('salesFrom')||{}).value||todayStr();
  const to=(document.getElementById('salesTo')||{}).value||from;
  if(!salesRows.length){toast('No data to export','err');return;}
  let csv='ID,Name,Category,Cost,Price,Opening,Purchases,Closing,Sales,Revenue,Profit\n';
  salesRows.forEach(r=>{csv+=`${r.id},"${r.name}","${r.cat}",${r.cost||''},${r.price||''},${r.opening},${r.purchases},${r.closing!=null?r.closing:''},${r.sales},${r.revenue},${r.profit}\n`;});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download=`SriSiriFoods_${from}_to_${to}.csv`;
  a.click();
  toast('‚úì CSV exported!','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äì INVENTORY VIEW & UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadInventoryView(){
  const date=(document.getElementById('invDate')||{}).value||todayStr();
  const cat=(document.getElementById('invCatFilter')||{}).value||'';
  const q=((document.getElementById('invSearch')||{}).value||'').toLowerCase();
  const wrap=document.getElementById('invWrap'); if(!wrap) return;
  const statsEl=document.getElementById('invStats'); if(!statsEl) return;
  let prods=getProds();
  if(cat) prods=prods.filter(p=>p.cat===cat);
  if(q) prods=prods.filter(p=>p.name.toLowerCase().includes(q)||p.id.toLowerCase().includes(q));
  const rows=prods.map(p=>{const st=getState(p.id,date);return{...p,...st};});
  // Stats
  const total=rows.reduce((s,r)=>s+r.max,0);
  const updated=rows.filter(r=>r.closing!=null).length;
  const lowStock=rows.filter(r=>r.max>0&&r.max<=5).length;
  statsEl.innerHTML=`
    <div class="stat-card"><div class="slbl">Total Units in Stock</div><div class="sval" style="color:var(--saffron);">${total}</div></div>
    <div class="stat-card"><div class="slbl">Products Stocked</div><div class="sval" style="color:var(--green);">${rows.filter(r=>r.max>0).length}</div></div>
    <div class="stat-card"><div class="slbl">Updated</div><div class="sval">${updated} / ${rows.length}</div></div>
    <div class="stat-card"><div class="slbl">Low Stock (‚â§5)</div><div class="sval" style="color:var(--red);">${lowStock}</div></div>`;
  if(!rows.length){wrap.innerHTML='<div class="nodata" style="padding:48px;">No products found.</div>';return;}

  // helper: inline number input for a column
  function cellInput(pid, colType, currentVal, maxVal, date){
    const hasVal = currentVal != null && currentVal !== undefined;
    const isClosing = colType === 'closing';
    const accentColor = colType==='opening'?'var(--green)':colType==='purchases'?'var(--blue)':'var(--saffron)';
    return `<div style="display:flex;flex-direction:column;gap:3px;align-items:center;">
      <input type="number" min="0" ${isClosing&&maxVal!=null?'max="'+maxVal+'"':''}
        value="${hasVal ? currentVal : ''}"
        placeholder="‚Äî"
        id="inv_${colType}_${pid}"
        style="width:68px;padding:5px 6px;border:2px solid ${hasVal?accentColor:'var(--border)'};border-radius:6px;font-size:13px;font-family:'DM Sans',sans-serif;outline:none;text-align:center;font-weight:${hasVal?'700':'400'};color:${hasVal?accentColor:'var(--muted)'};"
        onfocus="this.style.borderColor='${accentColor}';this.style.color='${accentColor}';"
        onblur="this.style.borderColor=this.value!==''?'${accentColor}':'var(--border)';"
        onkeydown="if(event.key==='Enter'){event.preventDefault();inlineSave('${pid}','${date}','${colType}',this.value);}">
    </div>`;
  }

  let h=`<table>
    <thead><tr>
      <th style="min-width:180px;">Product</th>
      <th>Category</th>
      <th style="text-align:center;min-width:90px;">
        Opening
        <div style="font-size:10px;font-weight:400;color:#aaa;text-transform:none;letter-spacing:0;">click cell ‚Üí Enter</div>
      </th>
      <th style="text-align:center;min-width:90px;">
        Purchases
        <div style="font-size:10px;font-weight:400;color:#aaa;text-transform:none;letter-spacing:0;">adds to stock</div>
      </th>
      <th style="text-align:center;min-width:80px;">Available</th>
      <th style="text-align:center;min-width:90px;">
        Closing
        <div style="font-size:10px;font-weight:400;color:#aaa;text-transform:none;letter-spacing:0;">must be ‚â§ available</div>
      </th>
      <th style="text-align:center;min-width:80px;">Sales</th>
      <th style="text-align:center;min-width:80px;">Status</th>
      <th style="text-align:center;min-width:80px;">Save Row</th>
    </tr></thead><tbody>`;

  rows.forEach(r=>{
    const sales = r.closing!=null ? Math.max(0, r.max - r.closing) : null;
    const status = r.closing!=null
      ?`<span style="background:var(--gl);color:var(--green);padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;">‚úì Done</span>`
      :`<span style="background:#FFF3E0;color:var(--sd);padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;">Pending</span>`;
    const availColor = r.max===0?'var(--red)':r.max<=5?'#E65100':'var(--green)';
    const salesColor = sales!=null&&sales>0?'var(--saffron)':'var(--muted)';

    h+=`<tr id="invrow_${r.id}" style="transition:background .2s;">
      <td>
        <div class="pname">${r.name}</div>
        <div class="pid">${r.id}</div>
      </td>
      <td><span class="cbadge">${r.cat}</span></td>
      <td style="text-align:center;">${cellInput(r.id,'opening',r.opening!==0||r.closing!=null?r.opening:null,null,date)}</td>
      <td style="text-align:center;">${cellInput(r.id,'purchases',r.purchases>0?r.purchases:null,null,date)}</td>
      <td style="text-align:center;font-weight:700;color:${availColor};font-size:16px;" id="avail_${r.id}">${r.max}</td>
      <td style="text-align:center;">${cellInput(r.id,'closing',r.closing,r.max,date)}</td>
      <td style="text-align:center;font-weight:700;color:${salesColor};font-size:16px;" id="sales_${r.id}">${sales!=null?sales:'<span style="color:#ddd">‚Äî</span>'}</td>
      <td style="text-align:center;">${status}</td>
      <td style="text-align:center;">
        <button onclick="saveRow('${r.id}','${date}')"
          style="padding:6px 14px;background:var(--saffron);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;transition:background .2s;"
          onmouseover="this.style.background='var(--sd)'" onmouseout="this.style.background='var(--saffron)'">
          Save
        </button>
      </td>
    </tr>`;
  });
  h+='</tbody></table>';
  wrap.innerHTML=h;
  // show log card
  renderInvLog();
  const lc=document.getElementById('invLogCard'); if(lc) lc.style.display='block';
}

// Save a single cell value (called on Enter key)
function inlineSave(pid, date, colType, val){
  const qty = parseInt(val);
  if(val===''||isNaN(qty)||qty<0){toast('Enter a valid number (0 or more)','err');return;}
  const st = getState(pid, date);
  if(colType==='closing'){
    // recalculate max including any just-entered opening/purchases from the same row
    const openingInput = document.getElementById('inv_opening_'+pid);
    const purchInput = document.getElementById('inv_purchases_'+pid);
    const op = openingInput&&openingInput.value!==''?parseInt(openingInput.value):st.opening;
    const pu = purchInput&&purchInput.value!==''?parseInt(purchInput.value):st.purchases;
    const liveMax = (isNaN(op)?0:op) + (isNaN(pu)?0:pu);
    if(qty > liveMax){
      toast('Closing ('+qty+') cannot exceed available ('+liveMax+')','err');
      const el=document.getElementById('inv_closing_'+pid); if(el) el.value=liveMax;
      return;
    }
  }
  const txns=getTxns();
  if(!txns[date]) txns[date]=[];
  if(colType==='closing'||colType==='opening'){
    txns[date]=txns[date].filter(t=>!(t.pid===pid&&t.type===colType));
  }
  txns[date].push({pid,type:colType,qty,ts:Date.now()});
  ss(SK.T,txns);
  // update available cell live without full re-render
  updateRowLive(pid, date);
  toast('‚úì Saved','ok');
  renderInvLog();
}

// Save all three columns of a row at once via "Save" button
function saveRow(pid, date){
  const opEl=document.getElementById('inv_opening_'+pid);
  const puEl=document.getElementById('inv_purchases_'+pid);
  const clEl=document.getElementById('inv_closing_'+pid);
  const opVal=opEl?opEl.value:'';
  const puVal=puEl?puEl.value:'';
  const clVal=clEl?clEl.value:'';

  let saved=0;
  const txns=getTxns();
  if(!txns[date]) txns[date]=[];

  if(opVal!==''){
    const op=parseInt(opVal);
    if(!isNaN(op)&&op>=0){
      txns[date]=txns[date].filter(t=>!(t.pid===pid&&t.type==='opening'));
      txns[date].push({pid,type:'opening',qty:op,ts:Date.now()});
      saved++;
    }
  }
  if(puVal!==''){
    const pu=parseInt(puVal);
    if(!isNaN(pu)&&pu>=0){
      // purchases stack ‚Äî only add if new value differs from existing total
      const existing=txns[date].filter(t=>t.pid===pid&&t.type==='purchase').reduce((s,t)=>s+t.qty,0);
      if(pu!==existing){
        txns[date]=txns[date].filter(t=>!(t.pid===pid&&t.type==='purchase'));
        if(pu>0) txns[date].push({pid,type:'purchase',qty:pu,ts:Date.now()});
        saved++;
      }
    }
  }
  if(clVal!==''){
    const cl=parseInt(clVal);
    if(!isNaN(cl)&&cl>=0){
      // compute max from saved state
      const st=getState(pid,date);
      if(cl>st.max){
        toast('Closing ('+cl+') exceeds available ('+st.max+')! Fix and try again.','err');
        return;
      }
      txns[date]=txns[date].filter(t=>!(t.pid===pid&&t.type==='closing'));
      txns[date].push({pid,type:'closing',qty:cl,ts:Date.now()});
      saved++;
    }
  }
  if(saved===0){toast('No values to save ‚Äî fill in at least one field','err');return;}
  ss(SK.T,txns);
  toast('‚úì Row saved ('+saved+' field'+(saved>1?'s':'')+')','ok');
  loadInventoryView();
}

// Update a single row's Available and Sales cells live after a cell save
function updateRowLive(pid, date){
  const st=getState(pid,date);
  const availEl=document.getElementById('avail_'+pid);
  const salesEl=document.getElementById('sales_'+pid);
  if(availEl){
    availEl.textContent=st.max;
    availEl.style.color=st.max===0?'var(--red)':st.max<=5?'#E65100':'var(--green)';
  }
  if(salesEl&&st.closing!=null){
    const s=Math.max(0,st.max-st.closing);
    salesEl.innerHTML=s>0?'<span style="color:var(--saffron);font-weight:700;">'+s+'</span>':'0';
  }
}

// ‚îÄ‚îÄ Inv panel transaction entry (full form) ‚îÄ‚îÄ
let invTxnType='closing';
function onInvDateChange(){
  const date=(document.getElementById('invTxnDate')||{}).value||'';
  const pid=(document.getElementById('invTxnProd')||{}).value||'';
  if(pid&&date) refreshInvInfoBox(pid,date);
  // sync view date
  const ivd=document.getElementById('invDate'); if(ivd&&date){ ivd.value=date; loadInventoryView(); }
}
function onInvCatChange(){
  const cat=(document.getElementById('invTxnCat')||{}).value||'';
  const sel=document.getElementById('invTxnProd'); if(!sel) return;
  sel.innerHTML='<option value="">‚Äî Select Product ‚Äî</option>';
  sel.disabled=!cat;
  const ib=document.getElementById('invInfoBox'); if(ib) ib.classList.remove('on');
  if(!cat) return;
  getProds().filter(p=>p.cat===cat).forEach(p=>{
    const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; sel.appendChild(o);
  });
}
function onInvProdChange(){
  const pid=(document.getElementById('invTxnProd')||{}).value||'';
  const date=(document.getElementById('invTxnDate')||{}).value||todayStr();
  const ib=document.getElementById('invInfoBox');
  if(!pid){if(ib) ib.classList.remove('on'); return;}
  refreshInvInfoBox(pid,date);
  if(ib) ib.classList.add('on');
  const qe=document.getElementById('invTxnQty'); if(qe) qe.value='';
}
function refreshInvInfoBox(pid,date){
  const p=getProds().find(x=>x.id===pid); if(!p) return;
  const st=getState(pid,date);
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set('invIOpen',st.opening);
  set('invIPurch',st.purchases);
  set('invIMax',st.max);
  set('invIClose',st.closing!=null?st.closing:'‚Äî');
  set('invICost',p.cost?'‚Çπ'+p.cost:'‚Äî');
  set('invISell',p.price?'‚Çπ'+p.price:'‚Äî');
}
function setInvTxnType(t){
  invTxnType=t;
  ['closing','purchase','opening'].forEach(x=>{
    const btn=document.getElementById('invbtn-'+x); if(!btn) return;
    btn.className='ttype-btn'; if(x===t) btn.classList.add('t-'+t);
  });
  const labels={closing:'Closing Stock (units)',purchase:'Purchases to Add (units)',opening:'Opening Stock (units)'};
  const ql=document.getElementById('invQtyLabel'); if(ql) ql.textContent=labels[t];
  const qe=document.getElementById('invTxnQty'); if(qe) qe.value='';
  if(t==='closing'){
    const pid=(document.getElementById('invTxnProd')||{}).value||'';
    const date=(document.getElementById('invTxnDate')||{}).value||todayStr();
    if(pid){const st=getState(pid,date);const qel=document.getElementById('invTxnQty');if(qel&&st.closing!=null)qel.value=st.closing;}
  }
}
function saveInvTxn(){
  const date=(document.getElementById('invTxnDate')||{}).value||'';
  const pid=(document.getElementById('invTxnProd')||{}).value||'';
  const raw=(document.getElementById('invTxnQty')||{}).value||'';
  const qty=parseInt(raw);
  if(!date){toast('Select a date','err');return;}
  if(!pid){toast('Select a product','err');return;}
  if(raw===''||isNaN(qty)||qty<0){toast('Enter a valid quantity','err');return;}
  const st=getState(pid,date);
  if(invTxnType==='closing'&&qty>st.max){
    toast('Closing ('+qty+') exceeds available ('+st.max+')!','err');
    const qe=document.getElementById('invTxnQty'); if(qe) qe.value=st.max; return;
  }
  const txns=getTxns();
  if(!txns[date]) txns[date]=[];
  if(invTxnType==='closing'||invTxnType==='opening'){
    txns[date]=txns[date].filter(t=>!(t.pid===pid&&t.type===invTxnType));
  }
  txns[date].push({pid,type:invTxnType,qty,ts:Date.now()});
  ss(SK.T,txns);
  refreshInvInfoBox(pid,date);
  const qe=document.getElementById('invTxnQty'); if(qe) qe.value='';
  // sync view
  const ivd=document.getElementById('invDate'); if(ivd) ivd.value=date;
  loadInventoryView();
  renderInvLog();
  toast('‚úì Saved!','ok');
}

function renderInvLog(){
  const date=(document.getElementById('invTxnDate')||document.getElementById('invDate')||{}).value||todayStr();
  const q=((document.getElementById('invLogSearch')||{}).value||'').toLowerCase();
  const wrap=document.getElementById('invLogWrap'); if(!wrap) return;
  const tl=document.getElementById('invLogTitle'); if(tl) tl.textContent='Log for '+fmtDate(date);
  const txns=getTxns();
  const prods=getProds();
  const day=(txns[date]||[]).slice().reverse();
  const filt=day.filter(t=>{
    const p=prods.find(x=>x.id===t.pid);
    const nm=p?p.name.toLowerCase():'';
    return!q||nm.includes(q)||t.pid.toLowerCase().includes(q);
  });
  if(!filt.length){wrap.innerHTML='<div class="nodata">No transactions for this date.</div>';return;}
  let h=`<table><thead><tr><th>Time</th><th>Product</th><th>Category</th><th>Type</th><th>Qty</th><th></th></tr></thead><tbody>`;
  filt.forEach((t,i)=>{
    const p=prods.find(x=>x.id===t.pid)||{name:t.pid,cat:'‚Äî'};
    const time=new Date(t.ts).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
    const tag={closing:'<span class="tag-c">Closing</span>',purchase:'<span class="tag-p">Purchase</span>',opening:'<span class="tag-o">Opening</span>'}[t.type]||t.type;
    const oi=(txns[date]||[]).length-1-i;
    h+=`<tr><td style="color:var(--muted);font-size:12px;">${time}</td>
      <td><div class="pname">${p.name}</div><div class="pid">${t.pid}</div></td>
      <td><span class="cbadge">${p.cat}</span></td>
      <td>${tag}</td>
      <td style="font-weight:700;">${t.qty}</td>
      <td><button class="btn-d" onclick="delInvTxn('${date}',${oi})">‚úï</button></td></tr>`;
  });
  h+='</tbody></table>';
  wrap.innerHTML=h;
}
function delInvTxn(date,idx){
  const txns=getTxns();
  if(!txns[date]||!txns[date][idx]) return;
  txns[date].splice(idx,1);
  ss(SK.T,txns);
  loadInventoryView();
  renderInvLog();
  toast('Deleted','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äì PRODUCTS & CATEGORIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addCategory(){
  const el=document.getElementById('newCatInput'); if(!el) return;
  const name=el.value.trim();
  if(!name){toast('Enter a category name','err');return;}
  const all=getAllCats();
  if(all.map(c=>c.toLowerCase()).includes(name.toLowerCase())){toast('Category already exists','err');return;}
  const cc=getCustomCats(); cc.push(name); ss(SK.CC,cc);
  el.value='';
  renderCatChips();
  populateAllDropdowns();
  populateInvCatFilter();
  buildCatPills();
  toast('‚úì Category added!','ok');
}
function deleteCat(cat){
  if(getProds().some(p=>p.cat===cat)){toast('Cannot delete ‚Äî products assigned to it','err');return;}
  const cc=getCustomCats().filter(c=>c!==cat); ss(SK.CC,cc);
  renderCatChips();
  populateAllDropdowns();
  populateInvCatFilter();
  toast('Category deleted','ok');
}
function renderCatChips(){
  const wrap=document.getElementById('catChips'); if(!wrap) return;
  const all=getAllCats();
  wrap.innerHTML=all.map(cat=>{
    const isBuiltIn=BUILT_IN_CATS.includes(cat);
    const delBtn=isBuiltIn?'':` <button class="del-cat" onclick="deleteCat('${cat}')" title="Delete">‚úï</button>`;
    return`<span class="cat-chip${isBuiltIn?' def':''}">${cat}${delBtn}</span>`;
  }).join('');
}
function renderProductTable(){
  const wrap=document.getElementById('prodWrap'); if(!wrap) return;
  const q=((document.getElementById('prodSearch')||{}).value||'').toLowerCase();
  const cat=(document.getElementById('prodCatFilter')||{}).value||'';
  let prods=getProds();
  if(q) prods=prods.filter(p=>p.name.toLowerCase().includes(q)||p.id.toLowerCase().includes(q));
  if(cat) prods=prods.filter(p=>p.cat===cat);
  if(!prods.length){wrap.innerHTML='<div class="nodata">No products found.</div>';return;}
  let h=`<table><thead><tr><th>ID</th><th>Product Name</th><th>Category</th><th>Cost</th><th>Price</th><th>Opening</th></tr></thead><tbody>`;
  prods.forEach(p=>{
    h+=`<tr>
      <td class="pid" style="font-weight:700;">${p.id}</td>
      <td class="pname">${p.name}</td>
      <td><span class="cbadge">${p.cat}</span></td>
      <td style="text-align:right;">${p.cost?'‚Çπ'+p.cost:'<span style="color:#ccc">‚Äî</span>'}</td>
      <td style="text-align:right;font-weight:600;color:var(--green);">${p.price?'‚Çπ'+p.price:'<span style="color:#ccc">‚Äî</span>'}</td>
      <td style="text-align:center;">${p.opening}</td>
    </tr>`;
  });
  h+='</tbody></table>';
  wrap.innerHTML=h;
}
function openAddProduct(){
  ['nProdId','nProdName','nProdCost','nProdPrice'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const el=document.getElementById('nProdStock'); if(el) el.value='0';
  const nc=document.getElementById('nProdCat'); if(nc) nc.value='';
  const max=getProds().reduce((m,p)=>{const n=parseInt(p.id.replace(/\D/g,''));return isNaN(n)?m:Math.max(m,n);},0);
  const pi=document.getElementById('nProdId'); if(pi) pi.value='P'+String(max+1).padStart(3,'0');
  openModal();
}
function saveNewProduct(){
  const g=id=>(document.getElementById(id)||{}).value||'';
  const id=g('nProdId').trim().toUpperCase();
  const name=g('nProdName').trim();
  const cat=g('nProdCat');
  const cost=parseInt(g('nProdCost'))||0;
  const price=parseInt(g('nProdPrice'))||0;
  const opening=parseInt(g('nProdStock'))||0;
  if(!id||!name||!cat){toast('Fill in ID, Name and Category','err');return;}
  const prods=getProds();
  if(prods.find(p=>p.id===id)){toast('Product ID already exists','err');return;}
  prods.push({id,name,cat,cost,price,opening});
  ss(SK.P,prods);
  closeModal();
  renderProductTable();
  populateAllDropdowns();
  toast('‚úì Product added!','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äì SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function unlockDateFn(){
  const el=document.getElementById('unlockDate'); if(!el||!el.value){toast('Select a date','err');return;}
  const ul=getUnlocked();
  if(!ul.includes(el.value)) ul.push(el.value);
  ss(SK.U,ul);
  renderUnlockedList();
  toast('‚úì Unlocked!','ok');
}
function renderUnlockedList(){
  const el=document.getElementById('unlockedList'); if(!el) return;
  const ul=getUnlocked();
  if(!ul.length){el.innerHTML='<span style="color:var(--muted);">No dates unlocked.</span>';return;}
  el.innerHTML='<b>Unlocked:</b> '+ul.map(d=>`<span style="background:var(--gl);color:var(--green);padding:2px 10px;border-radius:10px;margin:0 3px;font-size:12px;font-weight:700;">${d}</span>`).join('');
}
function changePw(r){
  const el=document.getElementById(r==='admin'?'newAdminPw':'newStaffPw'); if(!el) return;
  const v=el.value.trim();
  if(!v||v.length<4){toast('Min 4 characters','err');return;}
  const pws=getPws(); pws[r]=v; ss(SK.PW,pws);
  el.value='';
  toast('‚úì Password updated!','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmtDate(ds){return new Date(ds+'T00:00:00').toLocaleDateString('en-IN',{weekday:'short',month:'short',day:'numeric',year:'numeric'});}
function toast(msg,type='ok'){
  const t=document.getElementById('toast');
  if(!t) return;
  t.textContent=msg; t.className=type; t.classList.add('on');
  setTimeout(()=>t.classList.remove('on'),3000);
}
function openModal(){const m=document.getElementById('addProdModal');if(m)m.classList.add('on');}
function closeModal(){const m=document.getElementById('addProdModal');if(m)m.classList.remove('on');}
document.querySelectorAll('.modal-ov').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('on');}));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE SHEETS SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SHEETS_URL_KEY = 'ssf4_sheets_url';
const HARDCODED_URL  = 'https://script.google.com/macros/s/AKfycbx45c7LKkUCLIWfIJUg0InOaTU1bFkAdd83Pr9enrpKOos6CBC-eFmOLAwOB5j0GQYs/exec';

function getSheetsUrl(){
  return ls(SHEETS_URL_KEY) || HARDCODED_URL;
}

function saveSheetsUrl(){
  const el = document.getElementById('sheetsUrl'); if(!el) return;
  const url = el.value.trim();
  if(!url || !url.startsWith('https://script.google.com')){
    toast('Please enter a valid Apps Script URL','err'); return;
  }
  ss(SHEETS_URL_KEY, url);
  toast('‚úì URL saved!','ok');
}

function testSheetsConnection(){
  const url = getSheetsUrl();
  if(!url){ toast('No URL saved ‚Äî enter your Apps Script URL first','err'); return; }
  const statusEl = document.getElementById('sheetsStatus'); if(!statusEl) return;
  statusEl.innerHTML = '<span style="color:#888;">‚è≥ Testing connection...</span>';

  // Apps Script doPost requires POST ‚Äî use no-cors mode for ping
  fetch(url, {
    method: 'POST',
    mode: 'no-cors',
    headers: {'Content-Type':'text/plain'},
    body: JSON.stringify({ action: 'ping' })
  })
  .then(() => {
    // no-cors means we can't read the response body, but if no error the URL is reachable
    statusEl.innerHTML = '<span style="color:#188038;font-weight:600;">‚úÖ Connection successful! URL is reachable.</span>';
    toast('‚úì Connected to Google Sheets!','ok');
  })
  .catch(err => {
    statusEl.innerHTML = '<span style="color:var(--red);">‚ùå Failed: ' + err.message + '</span>';
    toast('Connection failed','err');
  });
}

async function syncToSheets(){
  const url = getSheetsUrl();
  if(!url){ toast('Set your Apps Script URL in Settings first','err'); return; }

  // Build sales rows from current salesRows data (or today if not loaded)
  let from = (document.getElementById('salesFrom')||{}).value || todayStr();
  let to   = (document.getElementById('salesTo')||{}).value   || from;

  // If salesRows is empty, load today's data
  if(!salesRows || !salesRows.length){
    from = to = todayStr();
    const prods = getProds();
    const date  = todayStr();
    salesRows = prods.map(p => {
      const st = getState(p.id, date);
      const sales   = st.closing != null ? Math.max(0, st.max - st.closing) : null;
      const revenue = sales != null && p.price ? sales * p.price : 0;
      const profit  = sales != null && p.price && p.cost ? sales * (p.price - p.cost) : 0;
      return {...p, ...st, sales, revenue, profit};
    });
  }

  // Build the payload ‚Äî one entry per date-product combination
  const dates   = getDatesInRange(from, to);
  const prods   = getProds();
  const allRows = [];

  dates.forEach(date => {
    prods.forEach(p => {
      const st      = getState(p.id, date);
      const sales   = st.closing != null ? Math.max(0, st.max - st.closing) : null;
      const revenue = sales != null && p.price ? sales * p.price : 0;
      const profit  = sales != null && p.price && p.cost ? sales * (p.price - p.cost) : 0;
      allRows.push({
        date,
        id:       p.id,
        name:     p.name,
        category: p.cat,
        opening:  st.opening,
        purchases:st.purchases,
        closing:  st.closing,
        sales,
        cost:     p.cost  || 0,
        price:    p.price || 0,
        revenue,
        profit
      });
    });
  });

  if(!allRows.length){ toast('No data to sync','err'); return; }

  // Show syncing state
  const syncBtn = document.getElementById('syncBtn');
  if(syncBtn){ syncBtn.textContent = '‚è≥ Syncing...'; syncBtn.disabled = true; }
  toast('Syncing to Google Sheets...','ok');

  // Group rows by date and send one request per date
  const byDate = {};
  allRows.forEach(r => { if(!byDate[r.date]) byDate[r.date]=[]; byDate[r.date].push(r); });

  let totalProducts = 0, totalDates = 0, errors = 0;

  for(const [date, rows] of Object.entries(byDate)){
    try {
      const resp = await fetch(url, {
        method: 'POST',
        mode:   'no-cors',
        headers:{'Content-Type':'text/plain'},
        body:    JSON.stringify({ action: 'syncSales', date, rows })
      });
      // no-cors: can't read response, assume success if no throw
      totalProducts += rows.length;
      totalDates++;
    } catch(err){
      console.error('Sync error for', date, err);
      errors++;
    }
  }

  if(syncBtn){ syncBtn.textContent = '‚òÅÔ∏è Sync to Sheets'; syncBtn.disabled = false; }

  if(errors === 0){
    toast(`‚úÖ Synced ${totalProducts} products across ${totalDates} date${totalDates>1?'s':''}!`, 'ok');
    // Update last sync time in settings
    const statusEl = document.getElementById('sheetsStatus');
    if(statusEl){
      const now = new Date().toLocaleString('en-IN',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
      statusEl.innerHTML = `<span style="color:#188038;font-weight:600;">‚úÖ Last sync: ${now} ‚Äî ${totalProducts} products, ${totalDates} date${totalDates>1?'s':''} sent</span>`;
    }
  } else {
    toast(`Sync completed with ${errors} error(s) ‚Äî check console`,'err');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
initData();
selectRole('admin');
</script>
</body>
</html>
